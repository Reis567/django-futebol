{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container">
    <!-- Nome do time com destaque -->
    <div class="text-center mb-4">
        <h1 class="display-4 font-weight-bold">{{ time.nome }}</h1>
    </div>
    
    <div class="row">
        <!-- Coluna dos Jogadores Titulares -->
        <div class="col-md-6 text-center">
            <h3 class="font-weight-bold mb-4">Jogadores Titulares</h3>
            <ul id="titulares" class="list-group list-group-flush jogadores-list" ondrop="handleDrop(event)" ondragover="allowDrop(event)">
                {% for jogador in jogadores_titulares %}
                    <li class="list-group-item jogador-item" draggable="true" ondragstart="handleDragStart(event)" data-id="{{ jogador.id }}">
                        {{ jogador.nome }} ({{ jogador.numero_camisa }} - {{ jogador.get_posicao_display }})
                        <button class="btn btn-danger btn-sm remove-jogador" data-id="{{ jogador.id }}">X</button>
                    </li>
                {% empty %}
                    <li class="list-group-item">Nenhum jogador titular.</li>
                {% endfor %}
            </ul>
        </div>

        <!-- Coluna dos Jogadores do Banco -->
        <div class="col-md-6 text-center">
            <h3 class="font-weight-bold mb-4">Jogadores no Banco</h3>
            <ul id="banco" class="list-group list-group-flush jogadores-list" ondrop="handleDrop(event)" ondragover="allowDrop(event)">
                {% for jogador in jogadores_banco %}
                    <li class="list-group-item jogador-item" draggable="true" ondragstart="handleDragStart(event)" data-id="{{ jogador.id }}">
                        {{ jogador.nome }} ({{ jogador.numero_camisa }} - {{ jogador.get_posicao_display }})
                        <button class="btn btn-danger btn-sm remove-jogador" data-id="{{ jogador.id }}">X</button>
                    </li>
                {% empty %}
                    <li class="list-group-item">Nenhum jogador no banco.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmação de Exclusão</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="fecharModal()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Tem certeza que deseja excluir este jogador do time?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="fecharModal()">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">Excluir</button>
            </div>
        </div>
    </div>
</div>

<style>
    .jogadores-list {
        min-height: 200px;
        border: 1px solid #ccc;
        padding: 10px;
        background-color: #f8f9fa;
    }
    .jogador-item {
        cursor: move;
        margin-bottom: 5px;
        position: relative;
    }
    .remove-jogador {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background-color: red;
        color: white;
        border: none;
        cursor: pointer;
    }
</style>

<script>
    let jogadorParaExcluir = null;

    function handleDragStart(event) {
        event.dataTransfer.setData('text/plain', event.target.dataset.id);
    }

    function allowDrop(event) {
        event.preventDefault();
    }

    function handleDrop(event) {
        event.preventDefault();
        const jogadorId = event.dataTransfer.getData('text/plain');
        const novaPosicao = event.target.closest('.jogadores-list').id;  // 'titulares' ou 'banco'
        
        // Atualizar a UI
        const jogadorElement = document.querySelector(`[data-id="${jogadorId}"]`);
        event.target.appendChild(jogadorElement);

        // Enviar a alteração para o servidor
        fetch(`{% url 'atualizar_jogadores' time.id %}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                'jogador_id': jogadorId,
                'nova_posicao': novaPosicao
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
        })
        .catch(error => {
            console.error('Erro:', error);
        });
    }

    document.querySelectorAll('.remove-jogador').forEach(button => {
        button.addEventListener('click', function() {
            jogadorParaExcluir = this.dataset.id;
            $('#confirmDeleteModal').modal('show');
        });
    });

    document.getElementById('confirmDeleteButton').addEventListener('click', function() {
        if (jogadorParaExcluir) {
            fetch(`{% url 'remover_jogador' time.id %}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    'jogador_id': jogadorParaExcluir
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.querySelector(`[data-id="${jogadorParaExcluir}"]`).remove();
                    fecharModal();
                    jogadorParaExcluir = null;
                }
            })
            .catch(error => {
                console.error('Erro:', error);
            });
        }
    });

    function fecharModal() {
        $('#confirmDeleteModal').modal('hide');
    }
</script>
{% endblock %}